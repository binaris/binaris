---
- test: Test help output
  work_dir: /home/dockeruser/test
  steps:
    -   in: |-
           bn --help | sed 's/^.\{2\}//' # remove 2 space indent(YML parse quirk)
        out: |-

            Usage: bn [options] [command]

            Binaris command line interface


            Options:

              -V, --version      output the version number
              -p, --path <path>  Use directory dir. "init" will create this directory if needed.
              -h, --help         output usage information


            Commands:

              login              Login to your Binaris account using an API key
              logs [options]     Print the logs of a function
              init [options]     Initialize a function from template
              deploy [options]   Deploys a function to the cloud
              remove [options]   Remove a previously deployed function
              invoke [options]   Invoke a Binaris function

- test: Test login(good-path)
  work_dir: /home/dockeruser/test
  env:
    BINARIS_CONF_DIR: /home/dockeruser/test
  setup:
    - echo $BINARIS_API_KEY > /home/dockeruser/test/apikey
  cleanup:
    - bn remove
  steps:
    -   in: bn create
        out: |-
            Created function * in /home/dockeruser/test
              (use "bn deploy" to deploy the function)
    -   in: ((cat /home/dockeruser/test/apikey) | bn login)
        out: |-
            Please enter your Binaris API key to deploy and invoke functions.
            If you don't have a key, head over to https://binaris.com to request one
            *API Key: *
            Authentication Succeeded
              (use "bn create" to create a template function in your current directory)
    -   in: unset BINARIS_API_KEY && bn deploy
        out: |-
            Deployed function to *
              (use "bn invoke" to invoke the function)
        delay: 300

- test: Test create(good-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn create
        out: |-
            Created function * in /home/dockeruser/test
              (use "bn deploy" to deploy the function)
    -   in: bn create -f purplecannon -p /home/dockeruser/test/purplecannon
        out: |-
            Created function purplecannon in /home/dockeruser/test/purplecannon
              (use "bn deploy -p /home/dockeruser/test/purplecannon -f purplecannon" to deploy the function)

- test: Test deploy(good-path)
  work_dir: /home/dockeruser/test
  cleanup:
    - bn remove
  steps:
    -   in: bn create
        out: |-
            Created function * in /home/dockeruser/test
              (use "bn deploy" to deploy the function)
    -   in: bn deploy
        out: |-
            Deployed function to *
              (use "bn invoke" to invoke the function)
    -   in: bn deploy
        out: |-
            Deployed function to *
              (use "bn invoke" to invoke the function)

- test: Test invoke(good-path)
  work_dir: /home/dockeruser/test
  setup:
    - |-
      echo '{\"name\": \"unguessable\"}' > invoke.json
  cleanup:
    - bn remove
  steps:
    -   in: bn create
        out: |-
            Created function * in /home/dockeruser/test
              (use "bn deploy" to deploy the function)
    -   in: bn deploy
        out: |-
            Deployed function to *
              (use "bn invoke" to invoke the function)
    -   in: bn invoke
        out: |-
            Hello World!
        delay: 2000
    -   in: |-
            bn invoke -d '{\"name\": \"unguessable\"}'
        out: |-
            Hello unguessable!
    -   in: |-
            bn invoke -j invoke.json
        out: |-
            Hello unguessable!

- test: Test logs(good-path)
  work_dir: /home/dockeruser/test
  cleanup:
    - bn remove
  steps:
    -   in: bn create
        out: |-
            Created function * in /home/dockeruser/test
              (use "bn deploy" to deploy the function)
    -   in: bn deploy
        out: |-
            Deployed function to *
              (use "bn invoke" to invoke the function)
    -   in: bn invoke
        out: |-
           Hello World!
        delay: 3000
    -   in: bn logs
        out: |-
          [201*-*-*T*:*:*Z] Hello World!
        delay: 10000
    -   in: |-
            bn invoke -d '{\"name\": \"again\"}' 
        out: |-
            Hello again!
    -   in: bn logs
        out: |-
          [201*-*-*T*:*:*Z] Hello World!
          [201*-*-*T*:*:*Z] Hello again!
        delay: 10000
    -   in: |-
            bn invoke -d '{\"name\": \"for the last time\"}' 
        out: |-
            Hello for the last time!
    -   in: bn logs
        out: |-
          [201*-*-*T*:*:*Z] Hello World!
          [201*-*-*T*:*:*Z] Hello again!
          [201*-*-*T*:*:*Z] Hello for the last time!
        delay: 10000


- test: Test deploy invoke remove cycle commands(good-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn create
        out: |-
            Created function * in /home/dockeruser/test
              (use "bn deploy" to deploy the function)
    -   in: bn deploy
        out: |-
            Deployed function to *
              (use "bn invoke" to invoke the function)
    -   in: bn invoke
        out: |-
            Hello World!
        delay: 2000
    -   in: bn remove
        out: |-
            Removed function *
              (use "bn deploy" to re-deploy the function)

- test: Test login(bad-path)
  work_dir: /home/dockeruser/test
  env:
    BINARIS_API_KEY: unset
    BINARIS_CONF_DIR: /home/dockeruser/test
  steps:
    -   in: bn create
        out: |-
            Created function * in /home/dockeruser/test
              (use "bn deploy" to deploy the function)
    -   in: (echo 9397312) | bn login
        out: |-
            Invalid API key
        exit: 1

- test: Test create(bad-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn create -f a*b*c*
        out: |-
            Invalid characters in function name a*b*c*. Use only letters and digits
        exit: 1
    -   in: bn create -f a_b%c#d@e+
        out: |-
            Invalid characters in function name a_b%c#d@e+. Use only letters and digits
        exit: 1
    -   in: |-
           bn create -f a=b~c,d.
        out: |-
            Invalid characters in function name a=b~c,d.. Use only letters and digits
        exit: 1
    -   in: bn create -f a:b?c!d-
        out: |-
            Invalid characters in function name a:b?c!d-. Use only letters and digits
        exit: 1
    -   in: bn create -f tooooooooooooooooooooooooooooooooooooooooooooooolongggggggggggggggggggggggggggggggggggggggggggggggggggggggggg
        out: |-
            Function names cannot be longer than 58 characters.
        exit: 1

- test: Test invoke(bad-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn create -p /home/dockeruser/test/alloftheoptions
        out: |-
            Created function * in *
              (use "bn deploy*" to deploy the function)
    -   in: bn invoke -p /home/dockeruser/test/alloftheoptions -j myFile.json -d data
        out: |-
            Invoke flags --json(-j) and --data(-d) are mutually exclusive
        exit: 1
    -   in: bn invoke -p /home/dockeruser/test/alloftheoptions/ -j myFile.json
        out: |-
            ENOENT: no such file or directory, open 'myFile.json'
        exit: 1

- test: Invalid name in binaris.yml (bad-path)
  work_dir: /home/dockeruser/test
  setup:
    - bn create
    # replace line 2 of binaris.yml(function name) with a bad function name
    - sed -i '2 c \  inv*a#l@i-d:' binaris.yml
  steps:
    - in: bn deploy
      out: |-
          Invalid characters in function name inv*a#l@i-d. Use only letters and digits
      exit: 1

- test: Unknown command(bad-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn alwaysbad
        out: |-
            Unknown command: 'alwaysbad'. See 'bn --help'
        exit: 1

- test: No permission
  work_dir: /home/dockeruser/test
  setup:
    - mkdir /home/dockeruser/test/securedir
    - echo binaris | sudo  -S chown root:root /home/dockeruser/test/securedir
    - echo binaris | sudo  -S chmod 700 /home/dockeruser/test/securedir
  steps:
    -   in: bn create -p /home/dockeruser/test/securedir
        out: |-
            EACCES: permission denied, unlink '/home/dockeruser/test/securedir/function.js'
        exit: 1

- test: Superfluous output(bad-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn create init init
        out: |-
            Argument "*" is not a valid input to *
        exit: 1
    -   in: bn create sadmksad
        out: |-
            Argument "sadmksad" is not a valid input to create
        exit: 1
    -   in: bn deploy init
        out: |-
            Argument "init" is not a valid input to deploy
        exit: 1
    -   in: bn logs notlogs
        out: |-
            Argument "notlogs" is not a valid input to logs
        exit: 1

- test: No such path(bad-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn deploy -p /home/dockeruser/test/bogus/comeon/really/hello.js
        out: |-
            ENOENT: no such file or directory, open '/home/dockeruser/test/bogus/comeon/really/hello.js/binaris.yml'
        exit: 1
    -   in: bn invoke -p /home/dockeruser/test/never/will/exist
        out: |-
            ENOENT: no such file or directory, open '/home/dockeruser/test/never/will/exist/binaris.yml'
        exit: 1
    -   in: bn remove -p /home/dockeruser/test/hocus/pocus/fairy
        out: |-
            ENOENT: no such file or directory, open '/home/dockeruser/test/hocus/pocus/fairy/binaris.yml'
        exit: 1
    -   in: bn logs -p /home/dockeruser/test/what/ifitdidnt/exist
        out: |-
            ENOENT: no such file or directory, open '/home/dockeruser/test/what/ifitdidnt/exist/binaris.yml'
        exit: 1

- test: No binaris.yml in directory(bad-path)
  work_dir: /home/dockeruser/test
  setup:
    - mkdir -p /home/dockeruser/test/trollycopter
  steps:
    -   in: bn invoke -p /home/dockeruser/test/trollycopter -f icydiceymolecule
        out: |-
            ENOENT: no such file or directory, open '/home/dockeruser/test/trollycopter/binaris.yml'
        exit: 1

- test: No matching function(bad-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn create -f unrelatedname
        out: |- 
            Created function unrelatedname in /home/dockeruser/test
              (use "bn deploy -f unrelatedname" to deploy the function)
    -   in: bn deploy -f grouchybear
        out: |-
            Cannot find function 'grouchybear' in binaris.yml
        exit: 1

- test: No API key or conf file(bad-path)
  work_dir: /home/dockeruser/test
  env:
    BINARIS_API_KEY: unset
    BINARIS_CONF_DIR: /home/dockeruser/test
  steps:
    -   in: bn create
        out: |-
            Created function * in /home/dockeruser/test
              (use "bn deploy" to deploy the function)
    -   in: bn deploy
        out: |-
            Binaris conf file could not be read and BINARIS_API_KEY is undefined, please use "bn login"
        exit: 1

- test: Corrupt binaris conf file(bad-path)
  work_dir: /home/dockeruser/test
  setup:
    - echo 'INVALIDCONF' | tee /home/dockeruser/test/.binaris.yml > /dev/null
  env:
    BINARIS_API_KEY: unset
    BINARIS_CONF_DIR: /home/dockeruser/test
  steps:
    -   in: bn create
        out: |-
            Created function * in /home/dockeruser/test
              (use "bn deploy" to deploy the function)
    -   in: bn deploy
        out: |-
            Invalid Binaris conf file (missing API key) /home/dockeruser/test/.binaris.yml
        exit: 1

