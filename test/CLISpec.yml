---
# Because login now verifies that the provided APIKey is correct
# this test cannot run to completion with our current testing
# environment. Once we have a more reliable way of responding to
# prompts(in the tests) we can re-enable this test.
#
# - test: Test login(good-path)
#   work_dir: /home/dockeruser/test
#   env:
#     BINARIS_API_KEY: unset
#     BINARIS_CONF_DIR: /home/dockeruser/test
#   steps:
#     -   in: bn init -f regulatedguest -p /home/dockeruser/test/regulatedguest
#         out: |-
#             Initialized function regulatedguest in /home/dockeruser/test/regulatedguest
#               (use "bn deploy -p /home/dockeruser/test/regulatedguest -f regulatedguest" to deploy the function)
#     -   in: ((echo 12345) | bn login)
#         out: |-
#             Please enter your Binaris API key to deploy and invoke functions.
#             If you don't have a key, head over to https://binaris.com to request one
#             *API Key: 12345
#             Authentication Succeeded
#               (use "bn init" to initialize a template function in your current directory)
#     -   in: bn deploy -f regulatedguest -p /home/dockeruser/test/regulatedguest
#         out: |-
#             Deployed function to *regulatedguest
#               (use "bn invoke -p /home/dockeruser/test/regulatedguest -f regulatedguest" to invoke the function)
#         delay: 300

- test: Test init(good-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn init
        out: |-
            Initialized function * in /home/dockeruser/test
              (use "bn deploy" to deploy the function)
    -   in: bn init -f purplecannon -p /home/dockeruser/test/purplecannon
        out: |-
            Initialized function purplecannon in /home/dockeruser/test/purplecannon
              (use "bn deploy -p /home/dockeruser/test/purplecannon -f purplecannon" to deploy the function)

- test: Test deploy(good-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn init -f rogerdodger -p /home/dockeruser/test/rogerdodger
        out: |-
            Initialized function rogerdodger in *rogerdodger
              (use "bn deploy -p /home/dockeruser/test/rogerdodger -f rogerdodger" to deploy the function)
    -   in: bn deploy -f rogerdodger -p /home/dockeruser/test/rogerdodger
        out: |-
            Deployed function to *rogerdodger
              (use "bn invoke -p /home/dockeruser/test/rogerdodger -f rogerdodger" to invoke the function)
    -   in: bn deploy -f rogerdodger -p /home/dockeruser/test/rogerdodger
        out: |-
            Deployed function to *rogerdodger
                (use "bn invoke -p /home/dockeruser/test/rogerdodger -f rogerdodger" to invoke the function)

- test: Test all commands(good-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn init -f cherrycoke -p /home/dockeruser/test/cherrycoke
        out: |-
            Initialized function cherrycoke in /home/dockeruser/test/cherrycoke
              (use "bn deploy -p /home/dockeruser/test/cherrycoke -f cherrycoke" to deploy the function)
    -   in: bn deploy -p /home/dockeruser/test/cherrycoke
        out: |-
            Deployed function to *cherrycoke
              (use "bn invoke -p /home/dockeruser/test/cherrycoke" to invoke the function)
    -   in: bn invoke -f cherrycoke -p /home/dockeruser/test/cherrycoke
        out: |-
            Hello World!
        delay: 2000
    -   in: bn remove -p /home/dockeruser/test/cherrycoke
        out: |-
            Removed function cherrycoke
              (use "bn deploy -p /home/dockeruser/test/cherrycoke" to re-deploy the function)

- test: Test login(bad-path)
  work_dir: /home/dockeruser/test
  env:
    BINARIS_API_KEY: unset
    BINARIS_CONF_DIR: /home/dockeruser/test
  steps:
    -   in: bn init -f regulatedguest -p /home/dockeruser/test/regulatedguest
        out: |-
            Initialized function regulatedguest in /home/dockeruser/test/regulatedguest
              (use "bn deploy -p /home/dockeruser/test/regulatedguest -f regulatedguest" to deploy the function)
    -   in: ((echo 9397312) | bn login)
        out: |-
            bn: Invalid API key, please try again
        exit: 1

- test: Test invoke(bad-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn init -p /home/dockeruser/test/alloftheoptions
        out: |-
            Initialized function * in *
              (use "bn deploy*" to deploy the function)
    -   in: bn invoke -p /home/dockeruser/test/alloftheoptions -j myFile.json -d data
        out: |-
            bn: Invoke flags --json(-j) and --data(-d) are mutually exclusive
        exit: 1
    -   in: bn invoke -p /home/dockeruser/test/alloftheoptions/ -j myFile.json
        out: |-
            bn: *myFile.json is not a valid path to a JSON file
        exit: 1

- test: Unknown command(bad-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn alwaysbad
        out: |-
            bn: Unknown command: 'alwaysbad'. See 'bn --help'
        exit: 1

- test: No permission
  work_dir: /home/dockeruser/test
  setup:
    - mkdir /home/dockeruser/test/securedir
    - echo binaris | sudo  -S chown root:root /home/dockeruser/test/securedir
    - echo binaris | sudo  -S chmod 700 /home/dockeruser/test/securedir
  steps:
    -   in: bn init -p /home/dockeruser/test/securedir
        out: |-
            bn: Permission denied writing to path: /home/dockeruser/test/securedir*
        exit: 1

- test: Superfluous output(bad-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn init init init
        out: |-
            bn: Argument * is not a valid input to *
        exit: 1
    -   in: bn init sadmksad
        out: |-
            bn: Argument sadmksad is not a valid input to init
        exit: 1
    -   in: bn deploy init
        out: |-
            bn: Argument init is not a valid input to deploy
        exit: 1

- test: No such path(bad-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn deploy -p /home/dockeruser/test/bogus/comeon/really/hello.js
        out: |-
            bn: No such path: '/home/dockeruser/test/bogus/comeon/really/hello.js'
        exit: 1
    -   in: bn invoke -p /home/dockeruser/test/never/will/exist
        out: |-
            bn: No such path: '/home/dockeruser/test/never/will/exist'
        exit: 1
    -   in: bn remove -p /home/dockeruser/test/hocus/pocus/fairy
        out: |-
            bn: No such path: '/home/dockeruser/test/hocus/pocus/fairy'
        exit: 1

- test: No such directory(bad-path)
  work_dir: /home/dockeruser/test
  setup:
    - touch /home/dockeruser/test/someFile.js
    - mkdir -p /home/dockeruser/test/abcdefg
    - touch /home/dockeruser/test/abcdefg/anotherFile.txt
  steps:
    -   in: bn deploy -p /home/dockeruser/test/someFile.js
        out: |-
            bn: No such directory: '/home/dockeruser/test/someFile.js'
        exit: 1
    -   in: bn invoke -p /home/dockeruser/test/abcdefg/anotherFile.txt
        out: |-
            bn: No such directory: '/home/dockeruser/test/abcdefg/anotherFile.txt'
        exit: 1

- test: No binaris.yml in directory(bad-path)
  work_dir: /home/dockeruser/test
  setup:
    - mkdir -p /home/dockeruser/test/trollycopter
  steps:
    -   in: bn invoke -p /home/dockeruser/test/trollycopter -f icydiceymolecule
        out: |-
            bn: Cannot find binaris.yml in directory: /home/dockeruser/test/trollycopter
        exit: 1

- test: No matching function(bad-path)
  work_dir: /home/dockeruser/test
  steps:
    -   in: bn init -f unrelatedname -p /home/dockeruser/test/grouchybear
        out: |- 
            Initialized function unrelatedname in /home/dockeruser/test/grouchybear
              (use "bn deploy -p /home/dockeruser/test/grouchybear -f unrelatedname" to deploy the function)
    -   in: bn deploy -p /home/dockeruser/test/grouchybear -f grouchybear
        out: |-
            bn: Cannot find function 'grouchybear' in binaris.yml
        exit: 1

- test: No API key or conf file(bad-path)
  work_dir: /home/dockeruser/test
  env:
    BINARIS_API_KEY: unset
    BINARIS_CONF_DIR: /home/dockeruser/test
  steps:
    -   in: bn init -f banananasundae -p /home/dockeruser/test/banananasundae
        out: |-
            Initialized function * in *
              (use "bn deploy*" to deploy the function)
        exit: 0
    -   in: bn deploy -f banananasundae -p /home/dockeruser/test/banananasundae
        out: |-
            bn: Binaris conf file could not be read and BINARIS_API_KEY is undefined, please use "bn login"
        exit: 1

- test: Corrupt binaris conf file(bad-path)
  work_dir: /home/dockeruser/test
  setup:
    - echo 'INVALIDCONF' | tee /home/dockeruser/test/.binaris.yml > /dev/null
  env:
    BINARIS_API_KEY: unset
    BINARIS_CONF_DIR: /home/dockeruser/test
  steps:
    -   in: bn init -f yogurtsalad -p /home/dockeruser/test/yogurtsalad
        out: |-
            Initialized function * in *
              (use "bn deploy*" to deploy the function)
        exit: 0
    -   in: bn deploy -f yogurtsalad -p /home/dockeruser/test/yogurtsalad
        out: |-
            bn: Invalid Binaris conf file (missing API key) /home/dockeruser/test/.binaris.yml
        exit: 1